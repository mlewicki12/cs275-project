<!DOCTYPE html>
<html>
	<head>
		<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- required by bootstrap -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<!-- BootStrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

		<link rel="stylesheet" href="style.css">
		<title>Mellow-fy - Generator</title>
		<link rel="icon" type="image/png" href="favi.png">
		<meta charset="UTF-8">

		<script src="js.cookie.js"></script>
		<script type="text/javascript">
			var interval;

			function initSearch(state) {
				if (state == 1) {
					interval = setInterval(search, 1000);
				} else {
					clearInterval(interval);
					interval = null;
					search();
				}
			}

			function advMenu(){
				var url = './sliders.html';
				console.log("we here");
				$.ajax({
					url : url,
					type : 'GET',
					datatype : 'html',
					success : function(data){
						document.getElementById('advancedmenu').innerHTML = data;
				
					}
				});
				
				
			}

			/*'acousticness', 'danceability',
			'duration_ms', 'energy', 'instrumentalness',
			'key', 'liveness', 'loudness', 'mode',
			'popularity', 'speechiness', 'tempo',
			'valence'
			*/

			function limit(str) {
				var ret = str;
				if(str.length > 36) {
					ret = str.substring(0, 36);
					ret += '...';
				}

				return ret;
			}

			function addSong(info) {
				$('.search').val('');
				$('#results').empty();

				var cls = 'song';
				if($('#seeds').is(':empty')) {
					cls = 'song top';
				}

				var ret = songToHtml(info, cls, 'deleteSong(\'' + info.id + '\');');
				$('#seeds').append(ret);
			}

			function deleteSong(id) {
				$('#' + id).remove();
			}

			function esc(str) {
				return str.replace("'", "\\'");
			}

			function toSong(info, cls) {
				var arg = '{name:\'' + esc(info.name) + 
				       '\', album:\'' + esc(info.album.name) +
				       '\', artist:\'' + esc(info.artists[0].name) + 
				       '\', cover:\'' + esc(info.album.images[2].url) + 
				       '\', id:\'' + info.id + '\'}'; 
				
				var onClick = 'addSong(' + arg + ');';
				return songToHtml({ name: info.name,
						    album: info.album.name,
						    artist: info.artists[0].name,
						    cover: info.album.images[2].url,
						    id: info.id }, cls, onClick);
			}

			function songToHtml(info, cls, onclick) {
				var ret = '<div id="' + info.id + '" class="' + cls + '" onclick="' + onclick + '">';
				ret += '<img src="' + info.cover + '" class="album" alt="' + info.album + '"/> ';
				ret += '<div class="info"><p>' + limit(info.name) + '</p><p>' + limit(info.album) + '</p><p>' + limit(info.artist) + '</p></div>';
				return ret;
			}

			function searchify(text) {
				return text.replace(/\s/g, '%20');
			}

			var prev = '';
			function search(){
				var search = $('.search').val();
				if(search.length < 3 ) {
					$('#results').empty();
					return -1;
				} else if(search == prev) {
					return -1;
				}

				var url = './search?query=' + searchify(search) + '&access=' + Cookies.get('spotify_access');
				console.log('sending search request to ' + url);
				prev = search;

				$.ajax({
					type: 'GET',
					url: url,
					dataType: 'json',

					success: function(msg) {
						console.log(msg)
						$('#results').empty();
						for(var i = 0; i < msg.length; ++i) {
							var cls = 'song';
							if(i == msg.length - 1) {
								cls = 'bottom song';
							}

						$('#results').append(toSong(msg[i], cls));
						}
					},

					error: function(jgXHR, textStatus, errorThrown) {
						console.log('Error: ' + textStates + ' ' + errorThrown);
					}
				});
			}
			  
			function generateFunction(){
				console.log("here");
				var URL =  "./recommendations";

				

				console.log("machik vs noodle");
				$("#seeds").each(function(){
					console.log(this.id);
				});
				console.log(seeds);
				URL += "?tracks=";
				console.log(URL);

				$.ajax({
					url : URL,
					type : 'GET',
					datatype : 'html',
					success : function(data){
						console.log("recommendations sent");
					}
				});
			}
		</script>
	</head>

	<body>
		<div class="jumbotron text-center textPrimary background1">
			<a href="./"><h1 class="header">GENERATOR</h1></a>
			<p class="quote">Bottom text.</p>
		</div>

		<!-- Search form -->
		<div class="search-bar">
			<div class="active-pink-3">
				<input class="search form-control" type="text" placeholder="Search" aria-label="Search" onfocus="initSearch(1)" onfocusout="initSearch(2)">
			</div>

			<div class="songlist" id="results"></div>

			<div class="advancedsearch">
				<button type='button' class='btn btn-link' onclick="advMenu()">Advanced</button>
			</div>

			<div class="advancedmenu"></div>
			<br>

			<div class="songlist" id="seeds"></div>

			<br>

			<button type="button" class="btn btn-secondary thePink" onclick="generateFunction();">Generate</button>
		</div>
	</body>
</html>
